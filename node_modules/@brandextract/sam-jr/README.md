# SAM Jr.

A little tool to help working with SAM templates locally.

With this, each `http://samsite:999/Default.asp?pageid=X` can be run
locally at `http://localhost:9999/pages/X`.

## Installation

SAM requires node v7.0.0 or higher for `async/await` support.

```bash
npm install --save git+ssh://git@github.com:BrandExtract/sam-jr.git
```

## Hello SAM

There is an example setup in [examples/SAM](./examples/SAM) with basic configurations.

A more detailed step-by-step guide is below:

In your `index.js` (or `gulpfile.js`):

```node
const SAM = require('sam-jr');
const app = new SAM();
app.listen(9999, function() {
  console.log('SAM in runnning on port', 9999);
});
```

Create a system environment file `.env` with the following variables:

```.env
export DATABASE_URL=mssql://username:password@hostname:1433/database
export PORT=9999
```

The `DATABASE_URL` variable tells SAM Jr. how to connect to the site's
database to pull the XML data from.

Run your application:

```bash
node index.js
```

Page `id` can be seen at `http://localhost:9999/pages/:id`

By default, the XML will be saved and read from a `./cache` folder,
unless `useCache`|`-C, --no-cache` option is set. This folder will be
created if not exist.

An `override` query from request can also override the cache. It can
take values of `1` or `true` to override all caches, or comma-separated
list of node names to override. Examples:

- `override=page`: Override the "page" and the "chunk" nodes in page.
- `override=sites,navigation`: Override both "sites" and "navigation".
- `override=chunks`: Override the "chunk" nodes in the page.
- `override=true` | `override=1`: Override all.

## SQLEXPRESS

Follow server settings in this link: http://dba.stackexchange.com/questions/62165/i-cant-connect-to-my-servers-sql-database-via-an-ip-address

```.env
export DATABASE_URL=mssql://username:password@hostname\\SQLEXPRESS/database
export PORT=9999
```

## CLI

```bash
./node-modules/.bin/sam -p 9999 --database=mssql://user:pass@hostname:1433/instance
```

It will start a server on port 9999 connecting to the specified
database. You will need to login using your SAM credentials before
proceeding to any page.

By default, the CLI will not watch. If you want it to watch, use
multiple `-w` flags to specify the globs.

See `--help` for any other options.

```shell
$ sam --help

  Usage: sam [options] [directory]

  Options:

    -h, --help                  output usage information
    -V, --version               output the version number
    -d, --database <url>        Database URL to read data from.
    -p, --port [port]           The port SAM listens to. Default: random.
    -e, --max-age [seconds]     Token expiration. Default: 3600.
    -m, --memory                Keep most recent page in memory.
    -C, --no-cache              Do not cache the XML into file system.
    -w, --watch <glob>          A glob for files to watch. Supports multiple instances.
    -hk, --hook <module>        Optional module to call on events
    -t, --tunnel                Provide tunnel to the outside world.
```

## Hook support

Using either `hook` option or `-hk, --hook` CLI flag, user can specify
a module that exposes a function to run when a file event occurs, such
as "request", "change", "add", "remove". This function takes an event
name, and the path to the file. If the hook is "request", the function
must return a value or a promise, and the result will be sent to the
browser instead of the original requested file.

## Query string

Any query string used will be passed to the XSL template as parameters.

The `select` query string filters the XML to those that match the
provided selector. The syntax is similar to XPath. For example:

`/pages/1?select=page|sites|navigation/link[@parent-id=1]`

This will return the following XML:

```xml
<?xml version="1.0"?>
<SAM copyright="2001-2011 BrandExtract" directive="admin" ...>
  <page id="1" ...>...</page>
  <sites ...>...</sites>
  <navigation>
    <link id="2" parent-id="1"...>...</link>
    <link id="3" parent-id="1"...>...</link>
    <link id="4" parent-id="1"...>...</link>
    <link id="5" parent-id="1"...>...</link>
  </navigation>
</SAM>
```

Note that it does not return the full `navigation` node, but a modified
node with only matching `link` children.

Additionaly, the following variables are provided globally:

- `$HOME`: The `/SAM/navigation/link` node for the homepage.
- `$SITE`: The `/SAM/sites/site` node for the current site.

You can also specfiy a `QUERYSTRING` environment variable to be used as the
default querystring. They will be replaced with actual query string if any.

For example, you have the following in your `.env` file:

```sh
export QUERYSTRING="select=page|sites|navigation/link[@parent-id=1]"
```

When you go to '/pages/1.xml', it will load `page`, `sites`, `navigation`.

However, if you go to `/pages/1.xml?select=page`, it will then only load `page`.

## Structure

This library follows the same structure as SAM. At the very least, it needs:

```
- admin
  - xsl-library
- page-templates
  - _layout.xsl
```

The XSL stylesheet used for transformation is based on
`/SAM/page/apply-template` node in the XML, which is relative to the
`./page-templates` folder.

This can be changed with `SAM_TEMPLATES` environment variable to set
the base path of the templates folder.

The CLI can also takes an argument to specify where to load the site's
XSL stylesheets, i.e., the `cwd`. This is the same as setting the
`cwd` option when used as a library.

## A note about authentication

- By default, if you're not authenticated, you will be asked to login using your SAM credentials on that site. Once verified, a JWT token will be issued and stored into cookie. This token has the expiry in 1 hour, unless a `AUTH_DURATION` environment variable tells it otherwise.
- This JWT is signed with a secret hard-coded in `/lib/sam.js`. This can be overriden by `AUTH_SECRET` environment variable.
- The JWT token is automatically renewd on each request, so keep your token locally.
- You can also use the `AUTH_TOKEN` environment variable to set your own token with longer expiration. A JWT can be generated on `https://jwt.io/`. You will need SAM Jr. secret key, or use the one you set with `AUTH_SECRET`. The only required keys in the payload are `id`, which is your user's ID and `iss`, which needs to be `"SAM Jr."`.
- If `SAM_USERNAME` and `SAM_PASSWORD` are set, SAM Jr. will automatically login using those credentials.

## Features

- [x] Transform XML to HTML.
- [x] Route handling per pages.
- [x] Live reload.
- [x] Construct XML from Database.
- [x] Filter XML.
- [x] Login.
- [ ] Add page.
- [ ] Add chunk.

## Tips

### To get only `navigation/link` nodes for current site:

`select=page|sites/site|navigation/link[@leftPtr>={$HOME/@leftPtr} and @rightPtr<={$HOME/@rightPtr}]`

Note: For using in `.env` file, the `$` symbol needs to be escaped to `\$`.
