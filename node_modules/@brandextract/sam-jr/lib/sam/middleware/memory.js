/* jslint         indent  : 2,    maxerr   : 50,
  esnext : true, -W030   : true, node     : true
*/
const debug = require('debug')('SAM:memory')

module.exports = (config = {}) => {
  let memory = {
    for: -1,
    content: null,
    type: 'text/html'
  }

  return async (context, next) => {
    const override = context.query.override
    let pageId = context.params.id
    pageId = parseInt(pageId)

    if (!override && memory.for === pageId && memory.content) {
      debug(`Serving page ${pageId} from memory.`)
      context.body = memory.content
      context.type = memory.type
      if (!context.state.user) {
        // Set a temporary user for SAM with a high ID to avoid conflict.
        context.state.user = { id: 1 }
      }

      return
    }

    await next()
    // The page was changed, maybe to login page.
    if (parseInt(context.params.id) !== pageId) return

    let content = context.body.toString()

    debug(`Remembering page ${pageId}`)
    memory.for = pageId
    memory.content = content
    memory.type = context.type

    context.body = content
    return
  }
}
